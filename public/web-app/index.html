<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üåç Real-time AQI Monitoring</title>
  <!-- Tailwind CSS for styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js for data visualization -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* A little extra style to make the chart's tooltip match the original design */
    .chartjs-tooltip {
      background-color: #1F2937 !important;
      border: 1px solid #374151 !important;
      color: #F9FAFB !important;
      border-radius: 0.5rem !important;
      padding: 0.5rem !important;
    }
  </style>
</head>

<body class="min-h-screen bg-slate-900 text-white font-sans">
  <div id="app-container" class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header Section -->
    <header class="text-center mb-10">
      <h1 class="text-4xl font-extrabold tracking-tight text-cyan-400 sm:text-5xl">
        üåç Real-time AQI Monitoring
      </h1>
      <p class="mt-4 text-lg text-gray-400">
        IoT Air Quality Monitoring System,
        Real-time AQI data for Tier-2/3 cities, built for Hackathon 2025.
      </p>
    </header>

    <!-- Main Dashboard Content -->
    <main>
      <div class="space-y-8">
        <!-- Live Status and Title -->
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-bold text-white">Live Dashboard</h2>
          <div id="connection-status"
            class="flex items-center gap-2 px-3 py-1.5 rounded-full text-sm font-medium bg-yellow-500/20 text-yellow-400">
            <!-- Wifi Icon -->
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M5 12.55a11 11 0 0 1 14.08 0" />
              <path d="M1.42 9a16 16 0 0 1 21.16 0" />
              <path d="M8.53 16.11a6 6 0 0 1 6.95 0" />
              <line x1="12" x2="12.01" y1="20" y2="20" />
            </svg>
            <span id="connection-text">Connecting...</span>
          </div>
        </div>
        
        <!-- Main AQI Display -->
        <div id="main-aqi-display" class="p-8 rounded-2xl shadow-2xl text-center bg-gray-700">
          <h3 class="text-lg font-medium text-gray-300">PM2.5 Air Quality Index</h3>
          <p id="main-aqi-value" class="text-7xl font-extrabold my-2 text-gray-400">--</p>
          <p id="main-aqi-label" class="text-2xl font-semibold text-gray-400">Unknown</p>
          <p class="text-gray-400 text-sm mt-1">Based on Indian AQI Standards</p>
        </div>

        <!-- Sensor Cards Grid -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
          <!-- PM10 Card -->
          <div
            class="bg-slate-800/60 p-5 rounded-xl shadow-lg flex items-center space-x-4 transition-transform transform hover:scale-105 hover:bg-slate-800">
            <div class="p-3 rounded-full bg-blue-500/20 text-blue-400">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path
                  d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2" />
              </svg>
            </div>
            <div>
              <h4 class="text-sm font-medium text-gray-400">PM10</h4>
              <p class="text-2xl font-bold text-white"><span id="pm10-value">--</span> <span
                  class="text-base font-normal text-gray-400">¬µg/m¬≥</span></p>
            </div>
          </div>
          <!-- CO2 Card -->
          <div
            class="bg-slate-800/60 p-5 rounded-xl shadow-lg flex items-center space-x-4 transition-transform transform hover:scale-105 hover:bg-slate-800">
            <div class="p-3 rounded-full bg-gray-500/20 text-gray-300">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 17a5 5 0 0 0-5-5h-1.3a5 5 0 0 0-4.4-4H9a5 5 0 0 0-5 5H3a3 3 0 0 0 0 6h18a3 3 0 0 0 1-6Z" />
              </svg>
            </div>
            <div>
              <h4 class="text-sm font-medium text-gray-400">Carbon Dioxide (CO‚ÇÇ)</h4>
              <p class="text-2xl font-bold text-white"><span id="co2-value">--</span> <span
                  class="text-base font-normal text-gray-400">ppm</span></p>
            </div>
          </div>
          <!-- NOx Card -->
          <div
            class="bg-slate-800/60 p-5 rounded-xl shadow-lg flex items-center space-x-4 transition-transform transform hover:scale-105 hover:bg-slate-800">
            <div class="p-3 rounded-full bg-purple-500/20 text-purple-400">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="m8 3 4 8 5-5 5 15H2L8 3z" />
              </svg>
            </div>
            <div>
              <h4 class="text-sm font-medium text-gray-400">Nitrogen Oxides (NOx)</h4>
              <p class="text-2xl font-bold text-white"><span id="nox-value">--</span> <span
                  class="text-base font-normal text-gray-400">ppb</span></p>
            </div>
          </div>
          <!-- Temperature Card -->
          <div
            class="bg-slate-800/60 p-5 rounded-xl shadow-lg flex items-center space-x-4 transition-transform transform hover:scale-105 hover:bg-slate-800">
            <div class="p-3 rounded-full bg-amber-500/20 text-amber-400">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z" />
              </svg>
            </div>
            <div>
              <h4 class="text-sm font-medium text-gray-400">Temperature</h4>
              <p class="text-2xl font-bold text-white"><span id="temperature-value">--</span> <span
                  class="text-base font-normal text-gray-400">¬∞C</span></p>
            </div>
          </div>
          <!-- Humidity Card -->
          <div
            class="bg-slate-800/60 p-5 rounded-xl shadow-lg flex items-center space-x-4 transition-transform transform hover:scale-105 hover:bg-slate-800">
            <div class="p-3 rounded-full bg-sky-500/20 text-sky-400">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z" />
              </svg>
            </div>
            <div>
              <h4 class="text-sm font-medium text-gray-400">Humidity</h4>
              <p class="text-2xl font-bold text-white"><span id="humidity-value">--</span> <span
                  class="text-base font-normal text-gray-400">%</span></p>
            </div>
          </div>
        </div>
        <!-- Chart Container -->
        <div class="bg-slate-800/60 p-6 rounded-xl shadow-lg mt-8">
          <h3 class="text-xl font-semibold text-white mb-4">Historical Trends</h3>
          <div class="w-full h-72">
            <canvas id="data-chart"></canvas>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="text-center py-8 mt-10 text-gray-500 text-sm border-t border-gray-700">
      <p id="current-time-text">
        Current time in Bhavnagar, Gujarat, India is loading...
      </p>
      <p>&copy; <span id="current-year"></span> AQI 2025 Team. All rights reserved.</p>
    </footer>
  </div>

  <!-- Firebase and App Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // --- Firebase Configuration ---
    // IMPORTANT: These are public credentials for a specific read-only demo database.
    const firebaseConfig = {
      apiKey: "AIzaSyDPki4OvYu3DRXf__FsQj81vuZXsF-n380",
      authDomain: "aqi-hackathon-150925.firebaseapp.com",
      databaseURL: "https://aqi-hackathon-150925-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "aqi-hackathon-150925",
      storageBucket: "aqi-hackathon-150925.firebasestorage.app",
      messagingSenderId: "688524802229",
      appId: "1:688524802229:web:3a7bcda5d877cb15a2e6fc",
      measurementId: "G-4144PCG7J4"
    };

    // --- Initialize Firebase ---
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- Helper Functions ---
    const getAqiInfo = (pm25) => {
      if (pm25 === null || pm25 === undefined) return { label: 'Unknown', color: 'text-gray-400', bg: 'bg-gray-700' };
      if (pm25 <= 30) return { label: 'Good', color: 'text-green-400', bg: 'bg-green-500/20' };
      if (pm25 <= 60) return { label: 'Satisfactory', color: 'text-lime-400', bg: 'bg-lime-500/20' };
      if (pm25 <= 90) return { label: 'Moderate', color: 'text-yellow-400', bg: 'bg-yellow-500/20' };
      if (pm25 <= 120) return { label: 'Poor', color: 'text-orange-400', bg: 'bg-orange-500/20' };
      if (pm25 <= 250) return { label: 'Very Poor', color: 'text-red-500', bg: 'bg-red-500/20' };
      return { label: 'Severe', color: 'text-rose-600', bg: 'bg-rose-500/20' };
    };

    const formatValue = (value) => (value === null || value === undefined) ? '--' : parseFloat(value).toFixed(1);

    // --- DOM Element References ---
    const connectionStatusEl = document.getElementById('connection-status');
    const connectionTextEl = document.getElementById('connection-text');
    const mainAqiDisplayEl = document.getElementById('main-aqi-display');
    const mainAqiValueEl = document.getElementById('main-aqi-value');
    const mainAqiLabelEl = document.getElementById('main-aqi-label');

    const valueElements = {
      pm10: document.getElementById('pm10-value'),
      co2: document.getElementById('co2-value'),
      nox: document.getElementById('nox-value'),
      temperature: document.getElementById('temperature-value'),
      humidity: document.getElementById('humidity-value'),
    };

    // --- Chart.js Initialization ---
    let dataChart;
    const chartCanvas = document.getElementById('data-chart');

    function initializeChart() {
      if (!chartCanvas) return;
      const ctx = chartCanvas.getContext('2d');
      dataChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            { label: 'PM2.5', data: [], borderColor: '#F87171', backgroundColor: '#F8717120', borderWidth: 2, tension: 0.4, pointRadius: 0 },
            { label: 'PM10', data: [], borderColor: '#60A5FA', backgroundColor: '#60A5FA20', borderWidth: 2, tension: 0.4, pointRadius: 0 },
            { label: 'Temp (¬∞C)', data: [], borderColor: '#FBBF24', backgroundColor: '#FBBF2420', borderWidth: 2, tension: 0.4, pointRadius: 0 },
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { grid: { color: '#374151' }, ticks: { color: '#9CA3AF', fontSize: 12 } },
            y: { grid: { color: '#374151' }, ticks: { color: '#9CA3AF', fontSize: 12 } }
          },
          plugins: {
            legend: { labels: { color: '#9CA3AF', fontSize: 14 } },
            tooltip: {
              enabled: true,
              mode: 'index',
              intersect: false,
            }
          }
        }
      });
    }

    function updateChart(newData) {
      if (!dataChart) return;

      const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      dataChart.data.labels.push(timestamp);
      dataChart.data.datasets[0].data.push(newData.pm25);
      dataChart.data.datasets[1].data.push(newData.pm10);
      dataChart.data.datasets[2].data.push(newData.temperature);

      // Keep the chart clean by showing a maximum of 30 data points
      if (dataChart.data.labels.length > 30) {
        dataChart.data.labels.shift();
        dataChart.data.datasets.forEach(dataset => dataset.data.shift());
      }
      dataChart.update();
    }

    // --- Firebase Data Listener ---
    function startDataListener() {
      const sensorDataRef = ref(db, 'sensorData');
      onValue(sensorDataRef, (snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.val();

          // Update connection status
          connectionStatusEl.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full text-sm font-medium bg-green-500/20 text-green-400';
          connectionTextEl.textContent = 'Live';

          // Update main AQI display
          const aqiInfo = getAqiInfo(data.pm25);
          mainAqiDisplayEl.className = `p-8 rounded-2xl shadow-2xl text-center ${aqiInfo.bg}`;
          mainAqiValueEl.className = `text-7xl font-extrabold my-2 ${aqiInfo.color}`;
          mainAqiLabelEl.className = `text-2xl font-semibold ${aqiInfo.color}`;
          mainAqiValueEl.textContent = formatValue(data.pm25);
          mainAqiLabelEl.textContent = aqiInfo.label;

          // Update all other sensor cards
          for (const key in valueElements) {
            if (valueElements[key]) {
              valueElements[key].textContent = formatValue(data[key]);
            }
          }

          // Update the chart
          updateChart(data);

        } else {
          connectionStatusEl.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full text-sm font-medium bg-red-500/20 text-red-400';
          connectionTextEl.textContent = 'No Data';
        }
      }, (error) => {
        console.error("Firebase read failed: ", error);
        connectionStatusEl.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full text-sm font-medium bg-red-500/20 text-red-400';
        connectionTextEl.textContent = 'Error';
      });
    }

    // --- Footer Time and Year ---
    function updateFooter() {
      const timeEl = document.getElementById('current-time-text');
      const yearEl = document.getElementById('current-year');

      function setTime() {
        timeEl.textContent = `Current time in Bhavnagar, Gujarat, India is ${new Date().toLocaleTimeString('en-IN', { timeZone: 'Asia/Kolkata', hour12: true, hour: 'numeric', minute: 'numeric' })}.`;
      }

      setTime();
      setInterval(setTime, 1000); // Update time every second
      yearEl.textContent = new Date().getFullYear();
    }

    // --- App Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
      initializeChart();
      startDataListener();
      updateFooter();
    });
  </script>
</body>

</html>